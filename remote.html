<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <title>Autoware Remote Cockpit</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* 추가적인 스타일링이 필요하면 여기에 작성합니다. */
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-4">

    <!-- 주 컨테이너 -->
    <div class="w-full max-w-7xl">

        <!-- 헤더 -->
        <header class="mb-6 text-center">
            <h1 class="text-4xl font-bold text-gray-900">Autoware 원격 제어 🕹️</h1>
            <p class="text-lg text-gray-600 mt-2">
                연결 상태: <span id="status" class="font-bold text-yellow-600">연결 중...</span>
            </p>
        </header>

        <!-- 보안 경고 메시지 -->
        <div id="security-warning" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md mb-6" role="alert">
            <p class="font-bold">중요 보안 경고</p>
            <p>이 페이지를 인터넷에 노출하는 것은 매우 위험할 수 있습니다. VPN 사용을 강력히 권장합니다. VNC 비밀번호를 즉시 변경하세요.</p>
        </div>

        <!-- 컨트롤 패널 -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 text-center">제어 패널</h2>
            <div class="flex justify-center items-center gap-4 flex-wrap">
                <button id="startButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Auto 시작 (Engage)
                </button>
                <button id="stopButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none">
                    Auto 정지 (Disengage)
                </button>
            </div>
        </div>

        <!-- 상태 메시지 알림 -->
        <div id="toast" class="fixed bottom-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transition-opacity duration-300">
            알림 메시지
        </div>

        <!-- 원격 데스크톱 -->
        <div class="bg-white p-2 rounded-2xl shadow-lg">
             <h2 class="text-2xl font-semibold my-4 text-center">원격 데스크톱 (VNC)</h2>
            <div class="aspect-w-16 aspect-h-9">
                 <iframe id="vnc-iframe" class="w-full h-[80vh] border-2 border-gray-200 rounded-lg" title="Remote Desktop">
                    <p>브라우저가 iframe을 지원하지 않습니다.</p>
                </iframe>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 💡 [중요] Autoware PC의 '공인 IP 주소' 또는 'DDNS 호스트 이름'을 여기에 입력하세요.
        // 💡 VPN을 사용하는 경우, Autoware PC의 '내부 IP 주소' (예: '192.168.0.15')를 입력하세요.
        const AUTOWARE_ADDRESS = '192.168.0.15';

        // --- 아래 코드는 특별한 경우가 아니면 수정할 필요가 없습니다. ---

        const WEBSOCKET_URL = `ws://${AUTOWARE_ADDRESS}:9090`;
        const VNC_URL = `https://${AUTOWARE_ADDRESS}:6080/vnc.html?path=websockify&password=123456`;
        
        // VNC iframe 소스 설정
        document.getElementById('vnc-iframe').src = VNC_URL;

        const statusElement = document.getElementById("status");
        const startButton = document.getElementById("startButton");
        const stopButton = document.getElementById("stopButton");
        const toastElement = document.getElementById("toast");
        
        // 초기에는 버튼 비활성화
        startButton.disabled = true;
        stopButton.disabled = true;

        const ros = new ROSLIB.Ros({
            url: WEBSOCKET_URL
        });

        ros.on('connection', function() {
            console.log('Connected to websocket server.');
            statusElement.innerHTML = "✅ 연결 성공";
            statusElement.className = "font-bold text-green-600";
            startButton.disabled = false;
            stopButton.disabled = false;
            showToast('ROS 서버에 성공적으로 연결되었습니다.');
        });

        ros.on('error', function(error) {
            console.log('Error connecting to websocket server: ', error);
            statusElement.innerHTML = "❌ 연결 실패";
            statusElement.className = "font-bold text-red-600";
            startButton.disabled = true;
            stopButton.disabled = true;
            showToast('ROS 서버 연결에 실패했습니다. 주소를 확인하세요.', 'error');
        });

        ros.on('close', function() {
            console.log('Connection to websocket server closed.');
            statusElement.innerHTML = "🔌 연결 끊김";
            statusElement.className = "font-bold text-gray-500";
            startButton.disabled = true;
            stopButton.disabled = true;
            showToast('ROS 서버와의 연결이 끊겼습니다.', 'warning');
        });

        const engageTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/autoware/engage',
            messageType: 'autoware_auto_vehicle_msgs/msg/Engage'
        });

        window.startAuto = function() {
            const engageMsg = new ROSLIB.Message({ engage: true });
            engageTopic.publish(engageMsg);
            console.log('Published engage message: true');
            showToast('자율주행 시작(Engage) 명령을 전송했습니다.');
        }

        window.stopAuto = function() {
            const engageMsg = new ROSLIB.Message({ engage: false });
            engageTopic.publish(engageMsg);
            console.log('Published engage message: false');
            showToast('자율주행 정지(Disengage) 명령을 전송했습니다.');
        }

        // 알림 메시지를 보여주는 함수
        let toastTimeout;
        function showToast(message, type = 'info') {
            toastElement.textContent = message;
            toastElement.classList.remove('bg-blue-500', 'bg-red-500', 'bg-yellow-500');

            if (type === 'error') {
                toastElement.classList.add('bg-red-500');
            } else if (type === 'warning') {
                toastElement.classList.add('bg-yellow-500');
            } else {
                toastElement.classList.add('bg-blue-500');
            }
            
            toastElement.classList.add('opacity-100');
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toastElement.classList.remove('opacity-100');
            }, 3000);
        }

        // 보안 경고: VNC URL에 기본 비밀번호가 포함되어 있으면 경고 표시
        if (VNC_URL.includes('password=123456')) {
            document.getElementById('security-warning').style.display = 'block';
        }

    </script>
</body>
</html>
