<!DOCTYPE html>
<html>
<head>
    <title>Autoware ì‹¤ì‹œê°„ ë°ì´í„° ê·¸ë˜í”„</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .chart-container {
            width: 80%;
            margin: 20px auto;
        }
        #lastUpdateTime {
            text-align: center;
            font-size: 0.9em;
            color: #666;
        }
        #error-message {
            text-align: center;
            font-size: 0.9em;
            color: red;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Autoware ì°¨ëŸ‰ ì‹¤ì‹œê°„ ë°ì´í„°</h1>
    
    <div class="chart-container">
        <canvas id="autowareSpeedChart"></canvas>
        <p id="lastUpdateTime">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ë¡œë”© ì¤‘...</p>
        <p id="error-message"></p>
    </div>

    <script>
        let speedChart; // ê·¸ë˜í”„ ê°ì²´ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        const MAX_DATA_POINTS = 20; // ê·¸ë˜í”„ì— í‘œì‹œí•  ìµœëŒ€ ë°ì´í„° ê°œìˆ˜

        // ğŸš¨ 1. [ìˆ˜ì •ë¨] Nginx í”„ë¡ì‹œ ë„ë©”ì¸ ì£¼ì†Œë¡œ ë³€ê²½ (í¬íŠ¸ 8080 ì œê±°)
        // ì´ ì£¼ì†Œë¡œ APIë¥¼ í˜¸ì¶œí•´ì•¼ Nginxê°€ 443 í¬íŠ¸ì—ì„œ ìš”ì²­ì„ ë°›ì•„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        const FLASK_API_BASE_URL = 'https://ros.fml2.shop';

        
        // 2. [ì‹ ê·œ] ê·¸ë˜í”„ë¥¼ ì²˜ìŒì— í•œ ë²ˆë§Œ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜
        function initializeChart() {
            // [ìˆ˜ì •ë¨] 'd'ê°€ ì•„ë‹Œ '2d'ê°€ ì˜¬ë°”ë¥¸ context IDì…ë‹ˆë‹¤.
            const ctx = document.getElementById('autowareSpeedChart').getContext('2d');
            
            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘
                    datasets: [{
                        label: 'ì°¨ëŸ‰ ì†ë„ (m/s)',
                        data: [], // ë¹ˆ ê°’ìœ¼ë¡œ ì‹œì‘
                        backgroundColor: 'rgba(255, 99, 132, 0.4)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 0 // ì—…ë°ì´íŠ¸ ì‹œ ì• ë‹ˆë©”ì´ì…˜ì„ ë”
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'ì†ë„ (m/s)'
                            }
                        }
                    }
                }
            });
        }

        // 3. [ìˆ˜ì •ë¨] APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì°¨íŠ¸ì— 'ì¶”ê°€'í•˜ëŠ” í•¨ìˆ˜
        function fetchAndDrawGraph() {
            
            // Nginx ê²½ë¡œì— ë§ê²Œ í˜¸ì¶œ (// ì´ì¤‘ ìŠ¬ë˜ì‹œ ë¬¸ì œ í•´ê²°ë¨)
            fetch(FLASK_API_BASE_URL + '/api/autoware') 
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ì˜¤ë¥˜! ì„œë²„ ìƒíƒœ: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Python APIê°€ ë°˜í™˜í•˜ëŠ” ë‹¨ì¼ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                    // (ê¸°ì¡´ data.labels, data.speed -> ì‹ ê·œ data.time, data.speed_mps)
                    const newLabel = new Date(data.time).toLocaleTimeString('ko-KR');
                    const newSpeed = data.speed_mps;

                    // ì°¨íŠ¸ ë°ì´í„°ì— ìƒˆ ê°’ì„ ì¶”ê°€
                    speedChart.data.labels.push(newLabel);
                    speedChart.data.datasets[0].data.push(newSpeed);

                    // ê·¸ë˜í”„ê°€ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šë„ë¡ ìµœëŒ€ ê°œìˆ˜ ì œí•œ
                    if (speedChart.data.labels.length > MAX_DATA_POINTS) {
                        speedChart.data.labels.shift(); // ê°€ì¥ ì˜¤ë˜ëœ ë¼ë²¨ ì œê±°
                        speedChart.data.datasets[0].data.shift(); // ê°€ì¥ ì˜¤ë˜ëœ ë°ì´í„° ì œê±°
                    }
                    
                    speedChart.update(); // ê·¸ë˜í”„ ì—…ë°ì´íŠ¸

                    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
                    document.getElementById('lastUpdateTime').textContent = 'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleTimeString('ko-KR');
                    document.getElementById('error-message').textContent = ''; // ì˜¤ë¥˜ ë©”ì‹œì§€ ì´ˆê¸°í™”
                })
                .catch(error => {
                    // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” CORS ì˜¤ë¥˜ ì‹œ ë©”ì‹œì§€ í‘œì‹œ
                    console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
                    document.getElementById('error-message').textContent = `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                });
        }

        // 4. í˜ì´ì§€ ë¡œë“œ ì‹œ ê·¸ë˜í”„ ì´ˆê¸°í™”
        initializeChart();
        
        // 5. ì¦‰ì‹œ 1íšŒ ì‹¤í–‰
        fetchAndDrawGraph();

        // 6. 2ì´ˆ(2000ms)ë§ˆë‹¤ ìë™ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê°±ì‹ 
        setInterval(fetchAndDrawGraph, 2000);
    </script>
</body>
</html>
